{% extends 'core/admin_base.html' %}
{% load static %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞–º–∏ - KinoCMS{% endblock %}

{% block extra_css %}
{% endblock %}

{% block page_title %}–ë–∞–Ω–Ω–µ—Ä—ã –∏ —Å–ª–∞–π–¥–µ—Ä—ã{% endblock %}

{% block breadcrumb_active %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞–º–∏{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        
        <!-- 1Ô∏è‚É£ –í–µ—Ä—Ö–Ω–∏–π –±–∞–Ω–Ω–µ—Ä (–ù–∞ –≥–ª–∞–≤–Ω–æ–π –≤–µ—Ä—Ö) -->
        <div class="banner-block top-banner">
            <div class="banner-header">
                <h4>üé¨ –ù–∞ –≥–ª–∞–≤–Ω–æ–π –≤–µ—Ä—Ö</h4>
                <label class="toggle-switch">
                    <input type="checkbox" id="top-banner-toggle" 
                           name="top-is_active" 
                           form="top-banner-form"
                           {% if top_slider_form.instance.is_active %}checked{% endif %}>
                    <span class="slider-toggle"></span>
                </label>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="top-banner-form">
                {% csrf_token %}
                {{ top_items_formset.management_form }}
                
                <div id="top-banner-formset" class="formset-grid">
                    {% for form in top_items_formset %}
                        <div class="formset-item" data-form-index="{{ forloop.counter0 }}">
                            <input type="hidden" name="{{ form.id.html_name }}" value="{{ form.id.value|default:'' }}" id="{{ form.id.id_for_label }}">
                            {% if form.instance.pk %}
                                <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" style="display: none;">
                            {% endif %}
                            
                            <div class="formset-item-content">
                                {% if form.instance.image %}
                                    <div class="image-preview-container">
                                        <img src="{{ form.instance.image.url }}" alt="–ë–∞–Ω–Ω–µ—Ä {{ forloop.counter }}" class="banner-image-preview">
                                        <div class="image-overlay">
                                            <button type="button" class="btn btn-sm btn-danger delete-banner-image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="empty-image-placeholder">
                                        <i class="fas fa-plus-circle"></i>
                                        <p>–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                                    </div>
                                {% endif %}
                                
                                <div class="image-upload-field">
                                    {{ form.image }}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.url.id_for_label }}">URL:</label>
                                    {{ form.url }}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.text.id_for_label }}">–¢–µ–∫—Å—Ç:</label>
                                    {{ form.text }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn-add-photo" id="add-top-photo">
                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                </button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="{{ top_slider_form.rotation_time.id_for_label }}">–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <select name="top-rotation_time" id="{{ top_slider_form.rotation_time.id_for_label }}" class="form-control rotation-select">
                        {% for value, label in top_slider_form.fields.rotation_time.choices %}
                            <option value="{{ value }}" {% if top_slider_form.instance.rotation_time == value %}selected{% endif %}>
                                {{ label }}s
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <input type="hidden" name="top-title" value="{{ top_slider_form.instance.title }}">
                <button type="submit" name="save_top" class="btn-save">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </form>
        </div>
        
        <!-- 2Ô∏è‚É£ –°–∫–≤–æ–∑–Ω–æ–π –±–∞–Ω–Ω–µ—Ä –Ω–∞ –∑–∞–¥–Ω–µ–º —Ñ–æ–Ω–µ -->
        <div class="banner-block background-banner">
            <div class="banner-header">
                <h4>üñºÔ∏è –°–∫–≤–æ–∑–Ω–æ–π –±–∞–Ω–Ω–µ—Ä –Ω–∞ –∑–∞–¥–Ω–µ–º —Ñ–æ–Ω–µ</h4>
            </div>

            <form method="post" enctype="multipart/form-data" id="background-banner-form">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-image me-2"></i>–¢–∏–ø —Ñ–æ–Ω–∞
                    </label>
                    <div class="mt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="bg-use_image" value="true"
                                   {% if background_form.instance.use_image %}checked{% endif %}
                                   id="bg-photo-option">
                            <label class="form-check-label" for="bg-photo-option">
                                –§–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="bg-use_image" value="false"
                                   {% if not background_form.instance.use_image %}checked{% endif %}
                                   id="bg-plain-option">
                            <label class="form-check-label" for="bg-plain-option">
                                –ü—Ä–æ—Å—Ç–æ —Ñ–æ–Ω
                            </label>
                        </div>
                    </div>
                </div>

                <div id="bg-photo-upload" class="{% if not background_form.instance.use_image %}hidden{% endif %}">
                    <div class="form-group">
                        {% if background_form.instance.image %}
                            <div style="margin-bottom: 15px;">
                                <img src="{{ background_form.instance.image.url }}" alt="Background" style="max-width: 300px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd; display: block; margin-bottom: 8px;">
                                <small style="color: #666;">{{ background_form.instance.image.name }}</small>
                            </div>
                        {% endif %}
                        {{ background_form.image }}
                    </div>
                </div>

                <button type="submit" name="save_background" class="btn-save">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </form>
        </div>

        <!-- 3Ô∏è‚É£ –ù–∏–∂–Ω–∏–π –±–∞–Ω–Ω–µ—Ä (–ù–∞ –≥–ª–∞–≤–Ω–æ–π –ù–æ–≤–æ—Å—Ç–∏ –ê–∫—Ü–∏–∏ –≤–Ω–∏–∑—É) -->
        <div class="banner-block bottom-banner">
            <div class="banner-header">
                <h4>üì∞ –ù–∞ –≥–ª–∞–≤–Ω–æ–π –ù–æ–≤–æ—Å—Ç–∏ –ê–∫—Ü–∏–∏ –≤–Ω–∏–∑—É</h4>
                <label class="toggle-switch">
                    <input type="checkbox" id="bottom-banner-toggle" 
                           name="bottom-is_active" 
                           form="bottom-banner-form"
                           {% if bottom_slider_form.instance.is_active %}checked{% endif %}>
                    <span class="slider-toggle"></span>
                </label>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="bottom-banner-form">
                {% csrf_token %}
                {{ bottom_items_formset.management_form }}
                
                <div id="bottom-banner-formset" class="formset-grid">
                    {% for form in bottom_items_formset %}
                        <div class="formset-item" data-form-index="{{ forloop.counter0 }}">
                            <input type="hidden" name="{{ form.id.html_name }}" value="{{ form.id.value|default:'' }}" id="{{ form.id.id_for_label }}">
                            {% if form.instance.pk %}
                                <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" style="display: none;">
                            {% endif %}
                            
                            <div class="formset-item-content">
                                {% if form.instance.image %}
                                    <div class="image-preview-container">
                                        <img src="{{ form.instance.image.url }}" alt="–ë–∞–Ω–Ω–µ—Ä {{ forloop.counter }}" class="banner-image-preview">
                                        <div class="image-overlay">
                                            <button type="button" class="btn btn-sm btn-danger delete-banner-image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="empty-image-placeholder">
                                        <i class="fas fa-plus-circle"></i>
                                        <p>–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                                    </div>
                                {% endif %}
                                
                                <div class="image-upload-field">
                                    {{ form.image }}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.url.id_for_label }}">URL:</label>
                                    {{ form.url }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn-add-photo" id="add-bottom-photo">
                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                </button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="{{ bottom_slider_form.rotation_time.id_for_label }}">–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <select name="bottom-rotation_time" id="{{ bottom_slider_form.rotation_time.id_for_label }}" class="form-control rotation-select">
                        {% for value, label in bottom_slider_form.fields.rotation_time.choices %}
                            <option value="{{ value }}" {% if bottom_slider_form.instance.rotation_time == value %}selected{% endif %}>
                                {{ label }}s
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <input type="hidden" name="bottom-title" value="{{ bottom_slider_form.instance.title }}">
                <button type="submit" name="save_bottom" class="btn-save">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </form>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initBannerManagement();
});

function initBannerManagement() {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É "–§–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω" –∏ "–ü—Ä–æ—Å—Ç–æ —Ñ–æ–Ω"
    const bgPhotoOption = document.getElementById('bg-photo-option');
    const bgPlainOption = document.getElementById('bg-plain-option');
    const bgPhotoUpload = document.getElementById('bg-photo-upload');
    
    function toggleBackgroundUpload() {
        if (bgPhotoOption && bgPhotoUpload) {
            if (bgPhotoOption.checked) {
                bgPhotoUpload.classList.remove('hidden');
            } else {
                bgPhotoUpload.classList.add('hidden');
            }
        }
    }
    
    if (bgPhotoOption) bgPhotoOption.addEventListener('change', toggleBackgroundUpload);
    if (bgPlainOption) bgPlainOption.addEventListener('change', toggleBackgroundUpload);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    window.handleBannerImagePreview = function(e, formsetItem) {
        const file = e.target.files[0];
        let previewContainer = formsetItem.querySelector('.image-preview-container');
        const placeholder = formsetItem.querySelector('.empty-image-placeholder');
        
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(event) {
                // –°–∫—Ä—ã–≤–∞–µ–º placeholder
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.className = 'image-preview-container';
                    const itemContent = formsetItem.querySelector('.formset-item-content');
                    itemContent.insertBefore(previewContainer, itemContent.firstChild);
                }
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                previewContainer.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const img = document.createElement('img');
                img.className = 'banner-image-preview';
                img.alt = '–ü—Ä–µ–≤—å—é –±–∞–Ω–Ω–µ—Ä–∞';
                img.src = event.target.result;
                
                // –°–æ–∑–¥–∞–µ–º overlay —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
                const overlay = document.createElement('div');
                overlay.className = 'image-overlay';
                overlay.innerHTML = `
                    <button type="button" class="btn btn-sm btn-danger delete-banner-image">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                previewContainer.appendChild(img);
                previewContainer.appendChild(overlay);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                overlay.querySelector('.delete-banner-image').addEventListener('click', function(event) {
                    event.stopPropagation();
                    markBannerForDeletion(formsetItem);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –ø—Ä–µ–≤—å—é –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∞–π–ª–∞
                previewContainer.addEventListener('click', function(event) {
                    if (!event.target.closest('.delete-banner-image')) {
                        e.target.click(); // –ö–ª–∏–∫–∞–µ–º –ø–æ –∏–Ω–ø—É—Ç—É —Ñ–∞–π–ª–∞
                    }
                });
            };
            reader.readAsDataURL(file);
        }
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    document.querySelectorAll('.formset-item input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const formsetItem = e.target.closest('.formset-item');
            handleBannerImagePreview(e, formsetItem);
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.delete-banner-image').forEach(button => {
        button.addEventListener('click', function() {
            const formsetItem = this.closest('.formset-item');
            markBannerForDeletion(formsetItem);
        });
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞
    const addTopPhotoBtn = document.getElementById('add-top-photo');
    if (addTopPhotoBtn) {
        addTopPhotoBtn.addEventListener('click', function() {
            const container = document.getElementById('top-banner-formset');
            const totalForms = document.querySelector('input[name="top_items-TOTAL_FORMS"]');
            
            if (!totalForms) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—Å–µ—Ç–æ–º');
                return;
            }
            
            const currentCount = parseInt(totalForms.value) || 0;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const newItem = document.createElement('div');
            newItem.className = 'formset-item';
            newItem.setAttribute('data-form-index', currentCount);
            
            newItem.innerHTML = `
                <input type="hidden" name="top_items-${currentCount}-id" id="id_top_items-${currentCount}-id" value="">
                <div class="formset-item-content">
                    <div class="empty-image-placeholder">
                        <i class="fas fa-plus-circle"></i>
                        <p>–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                        <div class="empty-image-overlay">
                            <button type="button" class="btn btn-sm btn-danger delete-empty-item" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="image-upload-field">
                        <input type="file" name="top_items-${currentCount}-image" accept="image/*"
                               class="form-control-file" id="id_top_items-${currentCount}-image">
                    </div>
                    <div class="form-group">
                        <label for="id_top_items-${currentCount}-url">URL:</label>
                        <input type="url" name="top_items-${currentCount}-url" class="form-control"
                               id="id_top_items-${currentCount}-url">
                    </div>
                    <div class="form-group">
                        <label for="id_top_items-${currentCount}-text">–¢–µ–∫—Å—Ç:</label>
                        <textarea name="top_items-${currentCount}-text" class="form-control"
                                  id="id_top_items-${currentCount}-text"></textarea>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
            container.appendChild(newItem);
            totalForms.value = currentCount + 1;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ input
            const newFileInput = newItem.querySelector('input[type="file"]');
            if (newFileInput) {
                newFileInput.addEventListener('change', function(e) {
                    handleBannerImagePreview(e, newItem);
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ placeholder
            const newPlaceholder = newItem.querySelector('.empty-image-placeholder');
            if (newPlaceholder) {
                newPlaceholder.addEventListener('click', function(e) {
                    // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                    if (!e.target.closest('.delete-empty-item')) {
                        newFileInput.click();
                    }
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const deleteBtn = newItem.querySelector('.delete-empty-item');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
                        newItem.remove();
                    }
                });
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞
    const addBottomPhotoBtn = document.getElementById('add-bottom-photo');
    if (addBottomPhotoBtn) {
        addBottomPhotoBtn.addEventListener('click', function() {
            const container = document.getElementById('bottom-banner-formset');
            const totalForms = document.querySelector('input[name="bottom_items-TOTAL_FORMS"]');
            
            if (!totalForms) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—Å–µ—Ç–æ–º');
                return;
            }
            
            const currentCount = parseInt(totalForms.value) || 0;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const newItem = document.createElement('div');
            newItem.className = 'formset-item';
            newItem.setAttribute('data-form-index', currentCount);
            
            newItem.innerHTML = `
                <input type="hidden" name="bottom_items-${currentCount}-id" id="id_bottom_items-${currentCount}-id" value="">
                <div class="formset-item-content">
                    <div class="empty-image-placeholder">
                        <i class="fas fa-plus-circle"></i>
                        <p>–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                        <div class="empty-image-overlay">
                            <button type="button" class="btn btn-sm btn-danger delete-empty-item" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="image-upload-field">
                        <input type="file" name="bottom_items-${currentCount}-image" accept="image/*"
                               class="form-control-file" id="id_bottom_items-${currentCount}-image">
                    </div>
                    <div class="form-group">
                        <label for="id_bottom_items-${currentCount}-url">URL:</label>
                        <input type="url" name="bottom_items-${currentCount}-url" class="form-control"
                               id="id_bottom_items-${currentCount}-url">
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
            container.appendChild(newItem);
            totalForms.value = currentCount + 1;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ input
            const newFileInput = newItem.querySelector('input[type="file"]');
            if (newFileInput) {
                newFileInput.addEventListener('change', function(e) {
                    handleBannerImagePreview(e, newItem);
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ placeholder
            const newPlaceholder = newItem.querySelector('.empty-image-placeholder');
            if (newPlaceholder) {
                newPlaceholder.addEventListener('click', function(e) {
                    // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                    if (!e.target.closest('.delete-empty-item')) {
                        newFileInput.click();
                    }
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const deleteBtn = newItem.querySelector('.delete-empty-item');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
                        newItem.remove();
                    }
                });
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ placeholder –∏ preview
    document.querySelectorAll('.formset-item').forEach(item => {
        const fileInput = item.querySelector('input[type="file"]');
        const placeholder = item.querySelector('.empty-image-placeholder');
        const previewContainer = item.querySelector('.image-preview-container');
        
        if (fileInput) {
            if (placeholder) {
                placeholder.addEventListener('click', function() {
                    fileInput.click();
                });
            }
            
            if (previewContainer) {
                previewContainer.addEventListener('click', function(e) {
                    // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                    if (!e.target.closest('.delete-banner-image')) {
                        fileInput.click();
                    }
                });
            }
        }
    });
}

function markBannerForDeletion(formsetItem) {
    const deleteCheckbox = formsetItem.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (deleteCheckbox) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞–Ω–Ω–µ—Ä?')) {
            deleteCheckbox.checked = true;
            formsetItem.classList.add('marked-for-deletion');
        }
    } else {
        // –î–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ checkbox –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏–∑ DOM
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∞–Ω–Ω–µ—Ä?')) {
            formsetItem.remove();
        }
    }
}
</script>
{% endblock %}
