{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KinoCMS{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2U5NDU2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTk0NTYwIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI2IiBmaWxsPSJub25lIiBzdHJva2U9IiNlOTQ1NjAiIHN0cm9rZS13aWR0aD0iMS41Ii8+CiAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMiIgZmlsbD0iI2U5NDU2MCIvPgogIDxjaXJjbGUgY3g9IjYiIGN5PSI4IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iMTgiIGN5PSI4IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iNiIgY3k9IjE2IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iMTgiIGN5PSIxNiIgcj0iMSIgZmlsbD0iI2U5NDU2MCIvPgogIDxjaXJjbGUgY3g9IjgiIGN5PSI2IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iMTYiIGN5PSI2IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iOCIgY3k9IjE4IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iMTYiIGN5PSIxOCIgcj0iMSIgZmlsbD0iI2U5NDU2MCIvPgo8L3N2Zz4K">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjZTk0NTYwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBmaWxsPSJub25lIiBzdHJva2U9IiNlOTQ1NjAiIHN0cm9rZS13aWR0aD0iMiIvPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2U5NDU2MCIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIyIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iNiIgY3k9IjgiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSIxOCIgY3k9IjgiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSI2IiBjeT0iMTYiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSIxOCIgY3k9IjE2IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+CiAgPGNpcmNsZSBjeD0iOCIgY3k9IjYiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSIxNiIgY3k9IjYiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSI4IiBjeT0iMTgiIHI9IjEiIGZpbGw9IiNlOTQ1NjAiLz4KICA8Y2lyY2xlIGN4PSIxNiIgY3k9IjE4IiByPSIxIiBmaWxsPSIjZTk0NTYwIi8+Cjwvc3ZnPgo=">

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/all.min.css' %}">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- KinoCMS Frontend Styles -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/frontend/site.css' %}">
    <link rel="stylesheet" href="{% static 'css/frontend/common.css' %}"> <!-- Common components -->
    <link rel="stylesheet" href="{% static 'css/frontend/search.css' %}">
    <link rel="stylesheet" href="{% static 'css/frontend/hero.css' %}">



    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Main Header -->
    <header class="main-header">

        <!-- Top bar with search, social icons, and phones -->
        <div class="top-bar">
            <div class="container">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <!-- Left side: Search form -->
                    <div class="search-form">
                        <input type="text" id="searchInput" placeholder="{% trans 'Поиск фильмов...' %}" autocomplete="off">
                        <button type="button" onclick="document.getElementById('searchInput').focus()"><i class="fas fa-search"></i></button>
                        <div class="search-results-dropdown" id="searchResults"></div>
                    </div>

                    <!-- Right side: Social icons and phones -->
                    <div class="d-flex align-items-center">
                        <!-- Social icons with brand colors -->
                        <div class="social-icons">
                            <a href="#" title="Facebook" class="facebook"><i class="fab fa-facebook"></i></a>
                            <a href="#" title="X (Twitter)" class="twitter-x">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                            </a>
                            <a href="#" title="Instagram" class="instagram"><i class="fab fa-instagram"></i></a>
                        </div>

                        <!-- Phone numbers -->
                        <div class="header-phones">
                            {% if page_main and page_main.status %}
                                <span>{{ page_main.phone_number1 }}</span>
                                <span>{{ page_main.phone_number2 }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation bar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <!-- Logo as first element in navbar -->
                <a class="navbar-brand-custom" href="/">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                        <!-- Cinema film reel icon -->
                        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                        <circle cx="12" cy="12" r="2" fill="currentColor"/>
                        <!-- Film holes -->
                        <circle cx="6" cy="8" r="1" fill="currentColor"/>
                        <circle cx="18" cy="8" r="1" fill="currentColor"/>
                        <circle cx="6" cy="16" r="1" fill="currentColor"/>
                        <circle cx="18" cy="16" r="1" fill="currentColor"/>
                        <circle cx="8" cy="6" r="1" fill="currentColor"/>
                        <circle cx="16" cy="6" r="1" fill="currentColor"/>
                        <circle cx="8" cy="18" r="1" fill="currentColor"/>
                        <circle cx="16" cy="18" r="1" fill="currentColor"/>
                    </svg>
                    KinoCMS
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i> {% trans "Главная" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'page:afisha' %}">
                                <i class="fas fa-film"></i> {% trans "Афиша" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'cinema:session_list' %}">
                                <i class="fas fa-calendar-alt"></i> {% trans "Расписание" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'page:soon' %}">
                                <i class="fas fa-clock"></i> {% trans "Скоро" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'cinema:cinema_list' %}">
                                <i class="fas fa-building"></i> {% trans "Кинотеатры" %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'page:sale_news_list' %}">
                                <i class="fas fa-percent"></i> {% trans "Акции" %}
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="aboutCinemaDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-info-circle"></i> {% trans "О кинотеатре" %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="aboutCinemaDropdown">
                                {% for page in system_pages %}
                                    <li><a class="dropdown-item" href="{% url 'page:page_detail' page.slug %}">{{ page.name }}</a></li>
                                {% endfor %}
                                {% for page in custom_pages %}
                                    <li><a class="dropdown-item" href="{% url 'page:page_detail' page.slug %}">{{ page.name }}</a></li>
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'page:contacts_public' %}">
                                    <i class="fas fa-phone"></i> {% trans "Контакты" %}
                                </a></li>
                            </ul>
                        </li>
                    </ul>

                    <ul class="navbar-nav">
                        {% if user.is_authenticated %}
                            <!-- Admin panel link for staff users -->
                            {% if user.is_staff %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'core:admin_dashboard' %}">
                                        <i class="fas fa-cog"></i> {% trans "Админ-панель" %}
                                    </a>
                                </li>
                            {% endif %}

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle"></i> {{ user.first_name|default:user.email }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="{% url 'users:profile' %}"><i class="fas fa-user"></i> {% trans "Профиль" %}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'users:logout' %}"><i class="fas fa-sign-out-alt"></i> {% trans "Выйти" %}</a></li>
                                </ul>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'users:login' %}">
                                    <i class="fas fa-sign-in-alt"></i> {% trans "Войти" %}
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'users:register' %}">
                                    <i class="fas fa-user-plus"></i> {% trans "Регистрация" %}
                                </a>
                            </li>
                        {% endif %}

                        <!-- Language selector -->
                        <li class="nav-item">
                            {% get_current_language as LANGUAGE_CODE %}
                            <div class="nav-link d-flex align-items-center">
                                <form method="post" action="{% url 'set_language' %}" style="display: inline;">
                                    {% csrf_token %}
                                    <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                    <input name="language" type="hidden" value="ru" />
                                    <button type="submit" class="btn btn-link p-0 text-decoration-none me-1 {% if LANGUAGE_CODE == 'ru' %}text-warning fw-bold{% else %}text-light{% endif %}" style="border: none; background: none;">RU</button>
                                </form>
                                <span class="text-muted">|</span>
                                <form method="post" action="{% url 'set_language' %}" style="display: inline;">
                                    {% csrf_token %}
                                    <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                    <input name="language" type="hidden" value="uk" />
                                    <button type="submit" class="btn btn-link p-0 text-decoration-none ms-1 {% if LANGUAGE_CODE == 'uk' %}text-warning fw-bold{% else %}text-light{% endif %}" style="border: none; background: none;">UA</button>
                                </form>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Hero Section (only on homepage) -->
    {% block hero %}{% endblock %}

    <!-- Django Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'error' %}
                        <i class="fas fa-exclamation-triangle me-2"></i>
                    {% elif message.tags == 'success' %}
                        <i class="fas fa-check-circle me-2"></i>
                    {% elif message.tags == 'info' %}
                        <i class="fas fa-info-circle me-2"></i>
                    {% elif message.tags == 'warning' %}
                        <i class="fas fa-exclamation-circle me-2"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main class="{% block main_class %}container my-5{% endblock %}">
        {% block content %}
        <!-- Default content -->
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5><i class="fas fa-video"></i> KinoCMS</h5>
                    <p class="text-muted">Современная сеть кинотеатров с лучшими фильмами и комфортными залами для незабываемого кинопросмотра.</p>
                    <div class="social-links">
                        <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
                        <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" title="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <div class="col-lg-2 col-md-6 mb-4">
                    <h5>Навигация</h5>
                    <ul class="list-unstyled">
                        <li><a href="/">Главная</a></li>
                        <li><a href="{% url 'page:afisha' %}">Афиша</a></li>
                        <li><a href="{% url 'cinema:session_list' %}">Расписание</a></li>
                        <li><a href="{% url 'page:soon' %}">Скоро</a></li>
                        <li><a href="{% url 'page:sale_news_list' %}">Акции</a></li>
                    </ul>
                </div>
            </div>

            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">

            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-muted mb-0">&copy; 2025 KinoCMS. Все права защищены.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">Разработано с <i class="fas fa-heart text-danger"></i> для любителей кино</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Local Bootstrap JS -->
    <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <!-- Custom JavaScript -->
    <script>
        // Header scroll effect (optional - can be removed if not needed)
        window.addEventListener('scroll', function() {
            const header = document.querySelector('.main-header');
            if (window.scrollY > 50) {
                header.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.4)';
            } else {
                header.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.3)';
            }
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add loading state to buttons (excluding form submit buttons)
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.btn:not([type="submit"])');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!this.classList.contains('no-loading') && this.tagName === 'A') {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<span class="loading-spinner me-2"></span>Загрузка...';
                        this.disabled = true;

                        setTimeout(() => {
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }, 2000);
                    }
                });
            });

            // Отдельная обработка для submit кнопок
            const submitButtons = document.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const form = this.closest('form');
                    if (form) {
                        const spinner = this.querySelector('.loading-spinner') || this.querySelector('.htmx-indicator');
                        if (spinner) {
                            spinner.style.display = 'inline-block';
                        }
                        // Не блокируем кнопку, позволяем форме отправиться
                    }
                });
            });
        });

        // Live Search for Movies
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout = null;

        if (searchInput && searchResults) {
            // Поиск при вводе текста
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                // Очищаем предыдущий таймаут
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Если запрос пустой или меньше 2 символов
                if (query.length < 2) {
                    searchResults.classList.remove('show');
                    searchResults.innerHTML = '';
                    return;
                }

                // Задержка перед запросом (300ms)
                searchTimeout = setTimeout(() => {
                    fetch(`{% url 'core:search_movies' %}?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            displaySearchResults(data.results);
                        })
                        .catch(error => {
                            console.error('Search error:', error);
                        });
                }, 300);
            });

            // Закрытие результатов при клике вне поиска
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('show');
                }
            });

            // Повторное открытие при фокусе
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length >= 2 && searchResults.innerHTML) {
                    searchResults.classList.add('show');
                }
            });
        }

        function displaySearchResults(results) {
            const currentLang = document.documentElement.lang || 'ru';

            if (!results || results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-search me-2"></i>{% trans "Ничего не найдено" %}</div>';
                searchResults.classList.add('show');
                return;
            }

            let html = '';
            results.forEach(movie => {
                const movieName = currentLang === 'uk' && movie.name_uk ? movie.name_uk : movie.name;
                const posterHtml = movie.poster
                    ? `<img src="${movie.poster}" alt="${movieName}" class="search-result-poster">`
                    : `<div class="search-result-placeholder"><i class="fas fa-film" style="color: var(--text-muted);"></i></div>`;

                html += `
                    <a href="${movie.url}" class="search-result-item">
                        ${posterHtml}
                        <div class="search-result-info">
                            <div class="search-result-name">${movieName}</div>
                        </div>
                    </a>
                `;
            });

            searchResults.innerHTML = html;
            searchResults.classList.add('show');
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>